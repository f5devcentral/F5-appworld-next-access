<!DOCTYPE html>
<head>
  
  <!-- Google Tag Manager -->
  <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src='https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);})(window,document,'script','dataLayer','GTM-PPZPQ6');</script>
  <!-- End Google Tag Manager -->
    <title>Lab 3.2: Test Security Policy</title>
  

  <meta charset="utf-8">
  <!-- Twitter Bootstrap viewport setting -->
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <!-- F5 metadata -->
  <meta name="title" content="Lab 3.2: Test Security Policy"/>
  <meta name="product" content="F5 BIG-IP Next Access Labs"/>
  <meta name="version" content=""/>
  <meta name="updated_date"  content="2024-02-06 20:02:46"/>
  <meta name="archived" content="Archived documents excluded"/>
  <meta name="doc_type" content="Manual"/>
  <meta name="lifecycle" content="release"/>
  <meta name="F5 BIG-IP Next Access Labs" content=""/>


  

  
  <link href="https://cdn.f5.com/favicon.ico" rel="icon">

</head>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Lab 3.2: Test Security Policy &#8212; F5 BIG-IP Next Access Labs  documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/css/bootstrap.min.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/graphviz.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css" />
    <link rel="stylesheet" href="../../_static/css/bootstrap.min.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/css/f5.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/css/f5-theme.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/css/CoveoFullSearch.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/css/custom.css" type="text/css" />
    <link rel="stylesheet" href="https://use.fontawesome.com/21fb8a09c3.css" type="text/css" />
    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/clipboard.min.js"></script>
    <script src="../../_static/copybutton.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/jquery.mark.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Lab 3.3: Test Money Transfer app" href="lab3.html" />
    <link rel="prev" title="Lab 3.1: Review and Deploy AS3 Declaration" href="lab1.html" /> 
  </head><body>
  <div id="clouddocs-header"></div>

    <div id="sidebar" class="section-nav">
      
      <!--  version selector ------------------>
      <div id="version_selector_wrapper">
      </div>
      <nav class="nav-sidebartoc">

        
         <h5>F5 BIG-IP Next Access Labs  </h5>
        

        <hr>
        <span class="nav-sidebartoc">
            <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="../waf302.html">WAF 302 - Enabling API Protection with APM and AWAF</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../waf302.html#intro">Intro</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../waf302.html#lab-scenario">Lab Scenario</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="../labinfo/labinfo.html">Lab Environment &amp; Topology</a></li>
<li class="toctree-l3"><a class="reference internal" href="../module1-petstore/module1.html">Module 1 - API Protection Using APM oAuth</a></li>
<li class="toctree-l3"><a class="reference internal" href="../module2-arcadiareview/module2.html">Module 2: AWAF Policy Template Creation on BIG-IP (secops engineer)</a></li>
<li class="toctree-l3 current"><a class="reference internal" href="module3.html">Module 3: Deploying a development instance of Arcadia Finance</a></li>
</ul>
</li>
</ul>
</li>
</ul>

        </span><!-- Use this file to add extra links to the bottom of the ToC sidebar -->
<hr>
  <span class="nav-sidebartoc">
 <!-- insert content here -->
  </span>
      </nav>
    </div>


    <div id="right-sidebar">
      <h7 style="font-weight:normal">On this page:</h7>
      <nav class="nav-sidebartoc">
        <span class="nav-sidebartoc">
            <ul>
<li><a class="reference internal" href="#">Lab 3.2: Test Security Policy</a><ul>
<li><a class="reference internal" href="#troubleshooting-note">Troubleshooting Note</a></li>
<li><a class="reference internal" href="#back-to-our-regularly-scheduled-lab">Back to our regularly scheduled lab…</a></li>
</ul>
</li>
</ul>

         </span>
      </nav>
    </div>





  
  <div class="main active" id="content" >
    <article class="docs-container site-article-inner">
              <!-- custom breadcrumb -->
        <h5>
            <a href="../../index.html">F5 BIG-IP Next Access Labs</a>
              &gt; <a href="../waf302.html">WAF 302 - Enabling API Protection with APM and AWAF</a>
              &gt; <a href="module3.html">Module 3: Deploying a development instance of Arcadia Finance</a>

          <span class="right">
             <a href="../../_sources/waf302/module3-deploydevdeploy/lab2.rst.txt" rel="nofollow">Source</a> |
             <a href="https://github.com/f5devcentral/F5-appworld-next-access">Edit on <i class="fa fa-github" aria-hidden="true"></i></a>
          </span>
        </h5>
        <!-- end custom breadcrumb -->
      


    <!--a title="Export PDF" id="export-pdf" class="btn btn btn-link pull-right">View PDF</a-->
    <button type="button" id="export-pdf" class="btn btn-link right">PDF</button>


    
     
         <div class="sidebar" id="version-warning" style="display: none;">
           <p class="first sidebar-title">
           <span class="icon fa fa-info-circle fa-lg"></span> Version notice:</p>
           <p class="last" id="currentVersion"></p>
          </div>


     <div role="main">
        
  <div class="section" id="lab-3-2-test-security-policy">
<h1>Lab 3.2: Test Security Policy<a class="headerlink" href="#lab-3-2-test-security-policy" title="Permalink to this headline">¶</a></h1>
<ol class="arabic simple">
<li>In the Postman <em>Arcadia Finance</em> &gt;&gt; <em>Dev</em> &gt;&gt; <em>Test API</em>, click on <em>DEV - Buy stocks</em> and replace the “qty” parameter value of “100” with the value of <strong>“hundred”</strong> and click <strong>Send</strong></li>
</ol>
<blockquote>
<div><img alt="../../_images/postman-qty-hundred.png" src="../../_images/postman-qty-hundred.png" />
</div></blockquote>
<p>2. Review support ID by going to <em>Application Security</em> &gt;&gt; <em>Event Logs</em> &gt;&gt; <em>Application</em>
It should be the request at the top, if not click the filter icon and search for your Support ID</p>
<ol class="arabic simple" start="3">
<li>Select the request</li>
</ol>
<img alt="../../_images/big-ip-security-event-hundred.png" src="../../_images/big-ip-security-event-hundred.png" />
<p>The request is flagged for an Illegal parameter data type. On the right-side, under <em>Occurrences</em>, click the number <strong>1</strong></p>
<img alt="../../_images/big-ip-security-event-hundred2.png" src="../../_images/big-ip-security-event-hundred2.png" />
<p>4. The policy expects an integer value, based on the OpenAPI file we imported
In Ubuntu CLI, type:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>grep -n qty /home/ubuntu/repo/arcadia/dev/arcadia-oas3-dev.json -A <span class="m">6</span> <span class="p">|</span> head –8
</pre></div>
</div>
<p>Notice the schema type for qty is “integer” – this sets our security policy configuration</p>
<img alt="../../_images/ubuntu-swagger-qty.png" src="../../_images/ubuntu-swagger-qty.png" />
<ol class="arabic simple" start="5">
<li>Grep for “company” instead of “qty” using the same command above:</li>
</ol>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>grep -n company /home/ubuntu/repo/arcadia/dev/arcadia-oas3-dev.json -A <span class="m">6</span> <span class="p">|</span> head -8
</pre></div>
</div>
<img alt="../../_images/ubuntu-swagger-company.png" src="../../_images/ubuntu-swagger-company.png" />
<p>How does the “string” value reflect in your security policy for this parameter?</p>
<ol class="arabic simple" start="6">
<li>Select <em>/trading/rest/buy_stocks.php</em> URL and click <em>URL Parameters</em> at the top.</li>
<li>In the BIG-IP, go to the  <em>Application Security</em> go to <em>URLs</em> &gt;&gt; <em>Allowed URLs</em> and select <strong>/trading/rest/buy_stocks.php</strong> URL and click <em>URL parameters</em></li>
<li>Select the <strong>“company”</strong> parameter and notice it’s Data Type is set to Alpha-Numeric</li>
</ol>
<dl class="docutils">
<dt>Review how the OpenAPI parameter settings (from our last grep command) influence your policy</dt><dd>required: <strong>true</strong>/false
in: <strong>body</strong>/query</dd>
</dl>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Style: form is required in order to support { key: value } pairs in this format.</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Explode: true tells the parser to create separate objects for each parameter</p>
</div>
<p>In Postman click on DEV - Buy stocks again and set qty back to 100
Change company to <em>“fubar”</em> and hit <strong>Send</strong></p>
<p>Q: Did the request succeed?  Should it have?</p>
<p>Change the company value to “cat /etc/ssl/certs/<em>.</em>” and click <strong>Send</strong></p>
<p>Q: Did the request succeed?  Review the security event log</p>
<p>In Postman, select the last transaction request and hit <strong>Send</strong></p>
<p>Set the response body in Postman to <em>“Preview”</em></p>
<p>Notice the blocked request does not make it to the backend database</p>
<img alt="../../_images/postman-transactionhistory.png" src="../../_images/postman-transactionhistory.png" />
<p>Since we don’t want erroneous values (like fubar) being accepted in our transaction database, let’s see how we can lock this down.</p>
<ol class="arabic simple" start="9">
<li>On the BIG-IP, go back to the company parameter for the <em>/trading/rest/buy_stocks.php</em> URL (<em>Security</em> &gt;&gt; <em>Application Security</em> &gt;&gt; <em>Parameters</em> &gt; <em>Parameter List</em> )</li>
</ol>
<p>In the Enum field, add <strong>FFIV</strong> to the list</p>
<img alt="../../_images/big-ip-security-ffiv.png" src="../../_images/big-ip-security-ffiv.png" />
<ol class="arabic simple" start="10">
<li>Click <em>Update</em> and be sure to <strong>Apply the policy</strong></li>
</ol>
<p>In Postman click the Buy Stocks request and change the company name to FFIV and click send
Request should succeed
Change company value to lower-case ffiv or any word other than FFIV and click Send
Review the security logs</p>
<p>We have proven we can lock the parameter down to specific values but since we are deploying as code, any changes we make directly to the security policy in the BigIP config will be lost if the application is redeployed.  The changes need to be made permanent by adding them to our OpenAPI Spec file.  Fortunately, OpenAPI allows you to define parameter enumerations.</p>
<ol class="arabic simple" start="11">
<li>In your Ubuntu CLI,</li>
</ol>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">cd</span> /home/ubuntu/repo/arcadia/dev
</pre></div>
</div>
<p>Use vi/nano to edit <em>arcadia-oas3-dev.json</em></p>
<p>Under the buy_stocks.php path, find the “company” parameter settings and edit the schema object to include enumerations as shown below.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="o">{</span>
  <span class="s2">&quot;name&quot;</span>: <span class="s2">&quot;company&quot;</span>,
  <span class="s2">&quot;in&quot;</span>: <span class="s2">&quot;body&quot;</span>,
  <span class="s2">&quot;required&quot;</span>: true,
  <span class="s2">&quot;style&quot;</span>: <span class="s2">&quot;form&quot;</span>,
  <span class="s2">&quot;explode&quot;</span>: true,
  <span class="s2">&quot;schema&quot;</span>: <span class="o">{</span>
    <span class="s2">&quot;type&quot;</span>: <span class="s2">&quot;string&quot;</span>,
    <span class="s2">&quot;enum&quot;</span>: <span class="o">[</span>
                <span class="s2">&quot;MSFT&quot;</span>,
                <span class="s2">&quot;AMZN&quot;</span>,
          <span class="s2">&quot;FFIV&quot;</span>
                <span class="o">]</span>
  <span class="o">}</span>
<span class="o">}</span>,
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">If using vi, to edit the json hit ‘i’ and the editor will enter the INSERT state. When done editing hit ESC then type :wq! And hit enter.</p>
</div>
<img alt="../../_images/meme-vi.jpg" src="../../_images/meme-vi.jpg" />
<p>When we make changes to our OpenAPI file, AS3 needs to re-import the file for settings to take effect. In this case, we need to delete the current Dev VIP and re-deploy it.</p>
<p>12. Go back to Postman and select the <em>Arcadia Finance</em> &gt;&gt; <em>Dev</em> &gt;&gt; <em>Test API</em>, click on <em>Delete DEV</em> request and hit <strong>Send</strong>
Once the Delete DEV request succeeds, Send the <strong>Deploy DEV w/OAS</strong> request to re-deploy and import the new parameter settings.</p>
<div class="section" id="troubleshooting-note">
<h2>Troubleshooting Note<a class="headerlink" href="#troubleshooting-note" title="Permalink to this headline">¶</a></h2>
<blockquote>
<div><p>If the deployment fails, confirm that you can load the swagger file from the webserver from the Windows RDP session to the following path: <a class="reference external" href="http://repo.itc.demo:8282/arcadia/dev/arcadia-oas3-dev.json">http://repo.itc.demo:8282/arcadia/dev/arcadia-oas3-dev.json</a></p>
<p>In the event your deployment fails as a result of a failed python web server, you can relaunch the webserver by using the following commands:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">cd</span> /home/ubuntu
pgrep python3 <span class="p">|</span>xargs <span class="nb">kill</span>
./start-web-server.sh
</pre></div>
</div>
</div></blockquote>
</div>
<div class="section" id="back-to-our-regularly-scheduled-lab">
<h2>Back to our regularly scheduled lab…<a class="headerlink" href="#back-to-our-regularly-scheduled-lab" title="Permalink to this headline">¶</a></h2>
<ol class="arabic simple" start="13">
<li>In Postman, select the <em>Arcadia Finance &gt; Dev &gt; Test API &gt; DEV</em> - sell stocks request and click <strong>Send</strong></li>
</ol>
<p>Why was the request blocked? Review the security event logs. On the right side, click the “5” under Occurrences.</p>
<img alt="../../_images/sellstock2.png" src="../../_images/sellstock2.png" />
<p>The policy is expecting our parameters to be sent as part of the query string rather than in the content. This would mean passing parameters in the form of</p>
<p><a class="reference external" href="https://arcdev.itc.demo/trading/rest/sell_stocks.php">https://arcdev.itc.demo/trading/rest/sell_stocks.php</a>?trans_value=1750&amp;qty=100&amp;….</p>
<p>Based on the production Arcadia deployment, we know this is incorrect and that our parameters are passed as json content. Let’s look at the OAS file to find the problem.</p>
<ol class="arabic simple" start="14">
<li>In Ubuntu CLI:</li>
</ol>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>less /home/ubuntu/repo/arcadia/dev/arcadia-oas3-dev.json
</pre></div>
</div>
<p>Scroll down until you see the sell_stocks path then review the parameters</p>
<img alt="../../_images/ubuntu-swagger-query.png" src="../../_images/ubuntu-swagger-query.png" />
<p>Chances are whoever created this file did a copy/paste and forgot to edit this value…and then turned it into a lab task.</p>
<p>Compare the parameter settings in OAS file between buy_stocks and sell_stocks
Since we know the requests have the same format, edit the arcadia-oas3-dev.json file sell_stocks parameters so they are located correctly in our security policy.</p>
<p>15. When you have finished editing the file, you will need to delete and re-deploy your VIP from Postman as you did earlier.
<em>Arcadia Finance</em> &gt;&gt; <em>Dev</em> &gt;&gt; <em>Test API</em>, click on <em>Delete DEV</em>
<em>Arcadia Finance</em> &gt;&gt; <em>Dev</em> &gt;&gt; <em>Test API</em>, click on <em>Deploy Dev w/OAS</em> - this will update our policy with new settings.</p>
<p>Ensure the security policy is accepting requests for DEV Buy, Sell and Last Transactions</p>
<ol class="arabic simple" start="16">
<li>Select either Buy or Sell Stocks and change the Content-Type header to text/plain as you did earlier in Prod, hit <strong>Send</strong>.</li>
</ol>
<img alt="../../_images/postman-contenttype.png" src="../../_images/postman-contenttype.png" />
<p>Q: Why is the request blocked this time?</p>
<p>In this scenario, our security policy is providing more value than just OWASP Top 10, we are also enforcing the API’s rules as a gateway, which is a great way to reduce noise, load and unnecessary risk on your backend containers.</p>
<p>Now that you are an OpenAPI pro and a JSON editing whiz, it’s time to put your skills to the test by adding the new Money Transfer microservice to our API gateway.</p>
</div>
</div>


     </div>
    
     <div class="row next-prev-btn-row">
       <div class="col-lg-12">
       
        <a href="lab1.html" title="Lab 3.1: Review and Deploy AS3 Declaration" accesskey="p" class="btn btn-primary left"><i class="fa fa-arrow-circle-left" aria-hidden="true"></i> Previous</a>
       
       
          <a href="lab3.html" title="Lab 3.3: Test Money Transfer app" accesskey="n" class="btn btn-primary right">Next <i class="fa fa-arrow-circle-right" aria-hidden="true"></i></a>
       
     </div>
     </div>
    

    </article>
  </div>

</div>


  <div id="clouddocs-footer"></div>
  <!-- Bootstrap core JavaScript
  ================================================== -->
  <!-- Placed at the end of the document so the pages load faster -->

  <script src="../../_static/js/index.js"></script>
  <script src="../../_static/js/jquery.appear.js"></script>
  <script src="../../_static/js/printThis.js"></script>
  <script src="../../_static/js/bootstrap.min.js"></script>
  <script src="../../_static/js/clouddocs.js"></script>
  <script src="../../_static/js/CoveoJsSearch.Lazy.min.js"></script>
  </body>
</html>